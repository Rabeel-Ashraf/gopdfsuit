<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GoPdfSuit - PDF Merge</title>
    <link rel="stylesheet" href="/static/css/viewer.css" />
    <link rel="stylesheet" href="/static/css/merge.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  </head>
  <body class="theme-dark">
    <header class="header">
      <div class="container">
        <h1>üìÑ GoPdfSuit - PDF Merge</h1>
        <p class="subtitle">
          Upload multiple PDFs to merge and preview the result in order
        </p>
      </div>
    </header>

    <main class="main-content">
      <div class="container">
        <div class="merge-container">
          <!-- Sidebar with controls -->
          <div class="merge-sidebar">
            <div class="controls-row" style="width: 100%">
              <div class="theme-controls">
                <button
                  id="themeToggle"
                  class="btn-small"
                  title="Toggle Light/Dark"
                >
                  üåû
                </button>
                <select
                  id="gradientSelect"
                  class="gradient-select"
                  title="Select Gradient Theme"
                ></select>
              </div>
            </div>

            <div class="input-section" style="margin-top: 12px">
              <label for="pdfFiles">Choose PDF files (multiple)</label>
              <input
                type="file"
                id="pdfFiles"
                accept="application/pdf"
                multiple
              />
              <div id="fileList" class="file-list" style="display: none"></div>
            </div>

            <div class="merge-actions" style="margin-top: 12px">
              <button id="mergeBtn" class="btn-merge-primary">
                <i class="fas fa-compress-arrows-alt"></i>
                Merge & Preview
              </button>
              <button id="downloadMerged" class="btn-merge-secondary" disabled>
                <i class="fas fa-download"></i>
                Download Merged PDF
              </button>
            </div>

            <div class="status-enhanced" style="margin-top: 12px">
              <div class="status-text" id="statusMessage">
                Ready to merge PDFs
              </div>
            </div>
          </div>

          <!-- Preview panel matching pdf_viewer.html structure -->
          <div class="merge-preview">
            <div class="merge-preview-header">
              <h3>
                <i class="fas fa-eye"></i>
                üìÑ PDF Preview
              </h3>
              <div class="pdf-controls">
                <button id="prevPage" disabled>‚óÄ</button>
                <span id="pageInfo">Page 1 of 1</span>
                <button id="nextPage" disabled>‚ñ∂</button>
                <button id="downloadBtn" disabled title="Download PDF">
                  ‚¨áÔ∏è
                </button>
              </div>
            </div>

            <div class="merge-preview-content">
              <div id="emptyState" class="merge-empty-state">
                <i class="fas fa-file-pdf"></i>
                <div>Select PDF files and click "Merge & Preview"</div>
                <div style="margin-top: 8px; font-size: 14px; opacity: 0.7">
                  Files will be merged in the order you select them
                </div>
              </div>

              <canvas
                id="pdfCanvas"
                class="merge-pdf-canvas"
                style="display: none"
              ></canvas>

              <div id="loadingIndicator" class="loading" style="display: none">
                <i class="fas fa-spinner fa-spin"></i>
                Processing merge...
              </div>

              <div id="errorIndicator" class="error" style="display: none">
                <i class="fas fa-exclamation-triangle"></i>
                Failed to load merged PDF
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <div class="container">
        <p>
          Made with ‚ù§Ô∏è by
          <a href="https://github.com/chinmay-sawant">Chinmay Sawant</a>
        </p>
      </div>
    </footer>

    <script src="/static/js/viewer.js"></script>
    <script>
      let mergedPDFBlob = null;
      let selectedFilesOrder = [];

      // Helper to build a stable id for a File (accessible to handlers)
      const fileId = (f) => `${f.name}|${f.size}|${f.lastModified}`;

      const renderSelectedFiles = () => {
        const fileList = document.getElementById("fileList");
        if (selectedFilesOrder.length === 0) {
          fileList.style.display = "none";
          fileList.innerHTML = "";
          return;
        }

        fileList.style.display = "block";
        fileList.innerHTML = "";

        selectedFilesOrder.forEach((file, index) => {
          const id = fileId(file);
          const fileItem = document.createElement("div");
          fileItem.className = "file-item";
          fileItem.setAttribute("data-id", id);
          fileItem.setAttribute("data-index", index);
          fileItem.setAttribute("draggable", "true");
          fileItem.innerHTML = `
              <div class="file-content">
                <div class="file-info">
                  <i class="fas fa-grip-vertical drag-indicator"></i>
                  <i class="fas fa-file-pdf file-icon"></i>
                  <span class="file-name">${file.name}</span>
                  <small class="file-order">#${index + 1}</small>
                </div>
                <button class="remove-btn" title="Remove" data-id="${id}">
                  <i class="fas fa-times">‚ùå</i>
                </button>
              </div>
            `;
          fileList.appendChild(fileItem);
        });

        // Add instruction note at the bottom
        const instructionNote = document.createElement("div");
        instructionNote.className = "drag-instruction";
        instructionNote.innerHTML = `
          <i class="fas fa-info-circle"></i>
          <span>Drag files to rearrange merge order</span>
        `;
        fileList.appendChild(instructionNote);
      };

      // File selection handler - preserve exact selection order across sequential picks
      document
        .getElementById("pdfFiles")
        .addEventListener("change", function (event) {
          const newFiles = Array.from(this.files || []);

          // For each file in the new selection (in the order the dialog reports):
          // - if it already exists in selectedFilesOrder, remove it from its old position
          //   and append it (so re-selecting reorders to the dialog order)
          // - if it's new, append it
          newFiles.forEach((f) => {
            const id = fileId(f);
            const existingIndex = selectedFilesOrder.findIndex(
              (sf) => fileId(sf) === id
            );
            if (existingIndex !== -1) {
              const [existingFile] = selectedFilesOrder.splice(
                existingIndex,
                1
              );
              selectedFilesOrder.push(existingFile);
            } else {
              selectedFilesOrder.push(f);
            }
          });

          renderSelectedFiles();

          console.log(
            "Files selected in order:",
            selectedFilesOrder.map((f) => f.name)
          );

          // Clear the native input so the user can 'add' files in multiple dialogs
          // while we keep the authoritative list in selectedFilesOrder.
          try {
            this.value = "";
          } catch (e) {
            // some browsers don't allow clearing, ignore
          }
        });

      // Delegated handler for remove button
      document
        .getElementById("fileList")
        .addEventListener("click", function (e) {
          const target = e.target.closest(".remove-btn");
          if (target) {
            const id = target.getAttribute("data-id");
            const idx = selectedFilesOrder.findIndex((f) => fileId(f) === id);
            if (idx !== -1) {
              selectedFilesOrder.splice(idx, 1);
              renderSelectedFiles();
            }
          }
        });

      // Simplified drag and drop reorder with hover-based behavior
      (function () {
        const fileListEl = document.getElementById("fileList");
        let draggedElement = null;
        let draggedIndex = null;

        fileListEl.addEventListener("dragstart", (e) => {
          const fileItem = e.target.closest(".file-item");
          if (!fileItem || fileItem.classList.contains("drag-instruction"))
            return;

          draggedElement = fileItem;
          draggedIndex = parseInt(fileItem.getAttribute("data-index"));
          e.dataTransfer.setData("text/plain", draggedIndex.toString());
          e.dataTransfer.effectAllowed = "move";

          // Add dragging class with animation
          fileItem.classList.add("dragging");
        });

        fileListEl.addEventListener("dragend", (e) => {
          const fileItem = e.target.closest(".file-item");
          if (fileItem) {
            fileItem.classList.remove("dragging");
          }

          // Remove all drop highlights
          document.querySelectorAll(".file-item").forEach((item) => {
            item.classList.remove("drag-hover");
          });

          draggedElement = null;
          draggedIndex = null;
        });

        fileListEl.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";

          if (!draggedElement) return;

          const targetItem = e.target.closest(".file-item");
          if (
            !targetItem ||
            targetItem === draggedElement ||
            targetItem.classList.contains("drag-instruction")
          ) {
            return;
          }

          // Clear all previous highlights
          document.querySelectorAll(".file-item").forEach((item) => {
            item.classList.remove("drag-hover");
          });

          // Highlight the target item
          targetItem.classList.add("drag-hover");
        });

        fileListEl.addEventListener("dragleave", (e) => {
          // Only clear highlights if leaving the file list entirely
          if (!fileListEl.contains(e.relatedTarget)) {
            document.querySelectorAll(".file-item").forEach((item) => {
              item.classList.remove("drag-hover");
            });
          }
        });

        fileListEl.addEventListener("drop", (e) => {
          e.preventDefault();

          if (draggedIndex === null) return;

          const targetItem = e.target.closest(".file-item");
          if (
            !targetItem ||
            targetItem === draggedElement ||
            targetItem.classList.contains("drag-instruction")
          ) {
            return;
          }

          const targetIndex = parseInt(targetItem.getAttribute("data-index"));

          // Perform the reorder - move dragged item to target position
          if (draggedIndex !== targetIndex) {
            const [movedFile] = selectedFilesOrder.splice(draggedIndex, 1);
            selectedFilesOrder.splice(targetIndex, 0, movedFile);

            console.log(
              `Moved file from position ${draggedIndex + 1} to ${
                targetIndex + 1
              }:`,
              selectedFilesOrder.map((f, i) => `${i + 1}. ${f.name}`)
            );

            renderSelectedFiles();
          }
        });
      })();

      // Merge and preview handler
      document
        .getElementById("mergeBtn")
        .addEventListener("click", async () => {
          const input = document.getElementById("pdfFiles");
          const status = document.getElementById("statusMessage");
          const emptyState = document.getElementById("emptyState");
          const loadingIndicator = document.getElementById("loadingIndicator");
          const canvas = document.getElementById("pdfCanvas");
          const errorIndicator = document.getElementById("errorIndicator");

          if (!selectedFilesOrder.length) {
            alert("Please choose at least one PDF file to merge");
            return;
          }

          // Show loading state
          emptyState.style.display = "none";
          canvas.style.display = "none";
          errorIndicator.style.display = "none";
          loadingIndicator.style.display = "flex";

          const form = new FormData();
          selectedFilesOrder.forEach((file) => {
            form.append("pdf", file);
          });

          status.textContent = "Merging PDFs...";

          try {
            const resp = await fetch("/api/v1/merge", {
              method: "POST",
              body: form,
            });

            if (!resp.ok) {
              throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
            }

            const blob = await resp.blob();
            mergedPDFBlob = blob;

            // Hide loading, show canvas
            loadingIndicator.style.display = "none";
            canvas.style.display = "block";

            // Load PDF in viewer (using the same logic as pdf_viewer.html)
            const viewer = window.gopdfViewer;
            if (viewer && typeof viewer.loadPDFFromBlob === "function") {
              await viewer.loadPDFFromBlob(blob);
              status.textContent = `Merged ${selectedFilesOrder.length} PDFs successfully`;

              // Enable both download buttons
              document.getElementById("downloadMerged").disabled = false;
              document.getElementById("downloadBtn").disabled = false;

              // Store blob for download
              viewer.currentPDFBlob = blob;
            } else {
              throw new Error("PDF viewer not available");
            }
          } catch (error) {
            loadingIndicator.style.display = "none";
            errorIndicator.style.display = "flex";
            status.textContent = "Error: " + error.message;
            console.error("Merge error:", error);
          }
        });

      // Download handlers
      document
        .getElementById("downloadMerged")
        .addEventListener("click", () => {
          if (mergedPDFBlob) {
            downloadPDF(mergedPDFBlob);
          }
        });

      document.getElementById("downloadBtn").addEventListener("click", () => {
        if (mergedPDFBlob) {
          downloadPDF(mergedPDFBlob);
        }
      });

      function downloadPDF(blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `merged-${new Date().getTime()}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        document.getElementById("statusMessage").textContent =
          "Merged PDF downloaded";
      }
    </script>
  </body>
</html>
